<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min Side | GloseMester</title>
    <link rel="icon" type="image/png" href="icon.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-weight: bold; font-size: 1.2rem; color: #0071e3; text-decoration: none; }
        
        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        h1 { margin-top: 0; }
        h2 { font-size: 1.2rem; color: #666; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            color: white;
            background: #999;
        }
        .status-premium { background: #27ae60; }
        .status-free { background: #7f8c8d; }
        .status-admin { background: #8e44ad; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .info-item label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .info-item div { font-size: 1.1rem; font-weight: 500; }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #0071e3;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-outline {
            background: transparent;
            border: 2px solid #0071e3;
            color: #0071e3;
            text-decoration: none;
        }
        .btn-outline:hover {
            background: #f0f7ff;
        }
        
        #error-log {
            background: #fff0f0;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffcdd2;
            margin-top: 20px;
            display: none;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

    <header class="header">
        <a href="/" class="logo">üéì GloseMester</a>
        <div style="display: flex; gap: 10px;">
            <a href="/" class="btn btn-outline" style="padding: 8px 16px;">
                ‚Üê Tilbake
            </a>
            <button class="btn btn-outline" id="logout-btn" style="border-color: #d32f2f; color: #d32f2f;">
                Logg ut
            </button>
        </div>
    </header>

    <div class="container">
        <h1>Hei, <span id="user-name">Laster...</span> üëã</h1>

        <!-- ABONNEMENT -->
        <div class="card">
            <h2>üì¶ Ditt Abonnement</h2>
            <div id="loading-msg">Kobler til database...</div>
            
            <div id="subscription-details" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <span id="status-badge" class="status-badge status-free">Gratis</span>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <label>Plan</label>
                        <div id="plan-name">-</div>
                    </div>
                    <div class="info-item">
                        <label>Utl√∏per</label>
                        <div id="expiry-date">-</div>
                    </div>
                    <div class="info-item">
                        <label>Betalingsmetode</label>
                        <div id="provider">-</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <a href="/oppgrader.html" id="upgrade-btn" class="btn">‚¨ÜÔ∏è Oppgrader til Premium</a>
                    <button id="manage-btn" class="btn btn-outline" style="display:none;" onclick="alert('Send e-post til kontakt@glosemester.no for √• endre eller avslutte abonnement.')">Administrer</button>
                </div>
            </div>
        </div>

        <!-- MIN PROFIL -->
        <div class="card">
            <h2>üë§ Min Profil</h2>
            <div class="info-grid">
                <div class="info-item">
                    <label>E-post</label>
                    <div id="user-email">-</div>
                </div>
                <div class="info-item">
                    <label>Bruker-ID</label>
                    <div id="user-id" style="font-size: 0.8rem; color: #999;">-</div>
                </div>
            </div>
        </div>

        <!-- SUPPORT & KONTAKT -->
        <div class="card">
            <h2>üí¨ Support & Kontakt</h2>
            <p>Trenger du hjelp eller har sp√∏rsm√•l om abonnementet ditt?</p>
            <div class="info-grid" style="margin-top: 20px;">
                <div class="info-item">
                    <label>E-post</label>
                    <div><a href="mailto:kontakt@glosemester.no" style="color: #0071e3; text-decoration: none;">kontakt@glosemester.no</a></div>
                </div>
                <div class="info-item">
                    <label>Responstid</label>
                    <div>Innen 2 virkedager</div>
                </div>
            </div>
            <div style="margin-top: 25px; display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="/vilkar.html" class="btn btn-outline">üìÑ Kj√∏psvilk√•r</a>
                <a href="/personvern.html" class="btn btn-outline">üîí Personvern</a>
            </div>
        </div>

        <!-- PERSONVERN & GDPR -->
        <div class="card">
            <h2>üõ°Ô∏è Personvern & Dine Rettigheter</h2>
            <p>I henhold til GDPR (personvernforordningen) har du f√∏lgende rettigheter:</p>

            <div style="margin-top: 20px;">
                <button onclick="window.eksporterMinData()" class="btn btn-outline" style="margin-bottom: 10px; width: 100%; max-width: 300px;">
                    üì• Last ned mine data
                </button>
                <p style="font-size: 0.85rem; color: #666; margin: 0 0 20px 0;">
                    Eksporter all din data i JSON-format (GDPR Artikkel 20 - Rett til dataportabilitet)
                </p>

                <button onclick="window.visCookieInnstillinger()" class="btn btn-outline" style="margin-bottom: 10px; width: 100%; max-width: 300px;">
                    üç™ Cookie-innstillinger
                </button>
                <p style="font-size: 0.85rem; color: #666; margin: 0 0 20px 0;">
                    Administrer dine cookie-preferanser
                </p>

                <button onclick="window.slettMinData()" class="btn btn-outline" style="margin-bottom: 10px; width: 100%; max-width: 300px; border-color: #d32f2f; color: #d32f2f;">
                    üóëÔ∏è Slett min konto
                </button>
                <p style="font-size: 0.85rem; color: #d32f2f; margin: 0;">
                    <strong>Advarsel:</strong> Dette sletter permanent all din data og kan ikke angres (GDPR Artikkel 17 - Rett til sletting)
                </p>
            </div>
        </div>

        <div id="error-log"></div>
    </div>

    <script type="module">
        import { auth, db, doc, getDoc, onAuthStateChanged, signOut } from './js/features/firebase.js';
        import { visCookieInnstillinger, slettMinData, eksporterMinData } from './js/features/gdpr.js';

        // Eksporter GDPR-funksjoner til window-objektet
        window.visCookieInnstillinger = visCookieInnstillinger;
        window.slettMinData = slettMinData;
        window.eksporterMinData = eksporterMinData;

        // Logg ut funksjon
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '/';
            } catch (error) {
                console.error("Logg ut feilet:", error);
            }
        });

        // Feilh√•ndtering
        function visFeil(msg) {
            console.error(msg);
            document.getElementById('loading-msg').innerText = "Kunne ikke hente info.";
            const log = document.getElementById('error-log');
            log.style.display = 'block';
            log.innerText += msg + "\n";
        }

        // Hovedlogikk
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("üë§ Bruker logget inn:", user.uid);
                
                try {
                    // Hent fra Firestore f√∏rst (har mer data)
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        console.log("üìã Firestore data:", userData);
                        
                        // ‚úÖ PRIORITER FIRESTORE-DATA
                        const displayName = userData.navn || user.displayName || "L√¶rer";
                        const displayEmail = userData.email || user.email || "-";
                        
                        document.getElementById('user-name').innerText = displayName;
                        document.getElementById('user-email').innerText = displayEmail;
                        document.getElementById('user-id').innerText = user.uid;
                        
                        visInfo(userData);
                    } else {
                        // Fallback til Firebase Auth data
                        console.warn("‚ö†Ô∏è Ingen Firestore-profil, bruker Auth-data");
                        document.getElementById('user-name').innerText = user.displayName || "L√¶rer";
                        document.getElementById('user-email').innerText = user.email || "-";
                        document.getElementById('user-id').innerText = user.uid;
                        visFeil("Fant ingen profil i databasen. Data hentes fra innlogging.");
                    }
                } catch (err) {
                    visFeil("Feil ved databasekall: " + err.message);
                }
            } else {
                window.location.href = '/';
            }
        });

        // Vis abonnementsdata
        function visInfo(data) {
            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('subscription-details').style.display = 'block';

            const sub = data.subscription || {};
            const abo = data.abonnement || {};

            let status = 'free';
            let planText = 'Gratis versjon';
            let expiryText = 'Aldri';
            let providerText = '-';

            // 1. Sjekk VIPPS PREMIUM
            if (sub.status === 'premium') {
                status = 'premium';
                
                if (sub.plan === 'premium_monthly') planText = 'Premium (M√•nedlig)';
                else if (sub.plan === 'premium_yearly') planText = 'Premium (√Örlig)';
                
                if (sub.expiresAt && sub.expiresAt.toDate) {
                    expiryText = sub.expiresAt.toDate().toLocaleDateString('no-NO');
                }
                providerText = 'Vipps';
            }
            // 2. Sjekk SKOLEPAKKE
            else if (abo.status === 'active' || abo.type === 'skolepakke') {
                status = 'admin';
                planText = abo.beskrivelse || 'Skolepakke';
                
                if (abo.utloper && abo.utloper.toDate) {
                    expiryText = abo.utloper.toDate().toLocaleDateString('no-NO');
                } else {
                    expiryText = 'Ubegrenset';
                }
                providerText = 'Faktura / Admin';
            }

            // Oppdater HTML
            const badge = document.getElementById('status-badge');
            const upgradeBtn = document.getElementById('upgrade-btn');
            const manageBtn = document.getElementById('manage-btn');

            document.getElementById('plan-name').innerText = planText;
            document.getElementById('expiry-date').innerText = expiryText;
            document.getElementById('provider').innerText = providerText;

            badge.className = 'status-badge'; 
            if (status === 'premium') {
                badge.classList.add('status-premium');
                badge.innerText = '‚≠ê Premium';
                upgradeBtn.style.display = 'none';
                manageBtn.style.display = 'inline-block';
            } else if (status === 'admin') {
                badge.classList.add('status-admin');
                badge.innerText = 'üè´ Skolepakke';
                upgradeBtn.style.display = 'none';
            } else {
                badge.classList.add('status-free');
                badge.innerText = 'FREE Gratis';
                upgradeBtn.style.display = 'inline-block';
                manageBtn.style.display = 'none';
            }
        }
    </script>

</body>
</html>